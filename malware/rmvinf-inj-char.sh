#!/bin/bash

source /home/sample/scripts/dataset.sh

input=$1

function check_input() {
	username=$(cat /etc/trueuserowners | awk '{print $1}' | sed 's/://' | awk -v user=$input '{if ($1==user) print $1}')

	if [[ $input == "$username" ]]; then
		tempdata="/home/$username/backup/tempdata.txt"

		if [ -f $tempdata ]; then
			get_data

			infected_list

			find_infected
		else
			echo "File not found"
		fi
	else
		echo "Username not found"
	fi
}

function get_data() {

	filter=$(cat $tempdata | grep "FILTER=" | sed 's/FILTER=//')

	pattern=$(cat $tempdata | grep "PATTERN=" | sed 's/PATTERN=//')

	count=$(cat $tempdata | grep "COUNT=" | sed 's/COUNT=//')

}

function infected_list() {
	imunify-antivirus malware malicious list --user $username --limit 10000 | sed '1d' | awk '{$1=$2=$3=$4=$5=$6=$7=$(NF-9)=$(NF-8)=$(NF-7)=$(NF-6)=$(NF-5)=$(NF-4)=$(NF-3)=$(NF-2)=$NF=""; print}' | grep "SMW-INJ-" | sed 's/^[[:space:]]*//' >>$temp/$username-inf-inj_$time.txt
}

function find_infected() {
	if [ -r $temp/$username-inf-inj_$time.txt ] && [ -s $temp/$username-inf-inj_$time.txt ]; then

		while IFS= read -r line || [[ -n "$line" ]]; do
			file=$(echo "$line" | awk '{$NF=""; print}' | sed 's/[[:blank:]]*$//')
			type=$(echo "$line" | awk '{print $NF}')
			dir=$(dirname $file)

			if [[ $type == "$filter" ]]; then
				linenos=($(cat $file | fgrep -n "$pattern" | awk -F':' '{print$1}'))
				lcount=${#linenos[@]}

				if [[ $lcount -ne 0 ]]; then
					last=$(sed -n '$=' $file)

					for ((i = 0; i < lcount; i++)); do
						lineno=${linenos[i]}

						if [[ $i -eq 0 && $lineno -eq 1 ]]; then
							rmv_infected

						elif [[ $i -eq 0 && $lineno -ne 1 ]]; then
							start=1
							end=$(echo $((${linenos[i]} - 1)))

							print_lines

							rmv_infected

						else
							start=$(echo $((${linenos[i - 1]} + 1)))
							end=$(echo $((${linenos[i]} - 1)))

							print_lines

							rmv_infected
						fi
					done

					if [[ $lineno -ne $last ]]; then
						start=$(echo $(($lineno + 1)))

						awk -v start=$start 'NR>start' $file >>$dir/rmvinftemp.txt
					fi

					if [ -r $dir/rmvinftemp.txt ] && [ -s $dir/rmvinftemp.txt ]; then
						mv -f $dir/rmvinftemp.txt $file

						chown $username:$username $file
					else
						echo "Not Replaced - $lineno - $last - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
					fi
				fi
			fi

		done <"$temp/$username-inf-inj_$time.txt"
	fi
}

function print_lines() {

	if [[ $start -eq $end ]]; then
		awk -v start=$start 'NR==start' $file >>$dir/rmvinftemp.txt

	elif [[ $start -lt $end ]]; then
		awk -v start=$start -v end=$end 'NR==start, NR==end' $file >>$dir/rmvinftemp.txt
	fi

}

function rmv_infected() {

	pchar=$(echo $pattern | wc -c)
	lchar=$(sed "${lineno}q;d" $file | sed 's/^[[:space:]]*//' | wc -c)

	fileline=$(sed "${lineno}q;d" $file | sed 's/^[[:space:]]*//')

	if [[ lchar -gt pchar ]]; then
		rest=${fileline#*$pattern}

		if [[ "$rest" != "$fileline" ]]; then
			schar=$(echo $((${#fileline} - ${#rest} - ${#pattern})))
			echar=$(echo $((${#fileline} - ${#rest} + 1)))
		else
			schar=$(echo $((${#fileline} - ${#pattern})))
			echar=$(echo $((${#fileline} + 1)))
		fi

		modify=$(sed "${lineno}q;d" $file | sed 's/^[[:space:]]*//' | awk -v schar=$schar -v echar=$echar '{print substr($0,1,schar) substr($0,echar)}')

		echo $modify >>$dir/rmvinftemp.txt

		echo "Modified - $lineno - $last - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt

	elif [[ lchar -eq pchar ]]; then
		if [[ $lineno -eq $last && $last -eq 1 ]]; then
			sed -i "${lineno}d" $file

			echo "File Removed - $lineno - $last - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
		else
			echo "Removed - $lineno - $last - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
		fi

	else
		echo "Failed - $lineno - $last - $file - $type" >>$svrlogs/malware/$username-inf-inj_$time.txt
	fi

}

check_input
