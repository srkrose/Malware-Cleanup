#!/bin/bash

source /home/sample/scripts/dataset.sh

function force_update() {

    wget https://repo.imunify360.cloudlinux.com/defence360/imunify-force-update.sh -O imunify-force-update.sh

    bash imunify-force-update.sh

    rm -f imunify-force-update.sh
}

function scan_date() {

    day_of_month="$(date +"%-d")"
    hour="18"

    imunify-antivirus config update "{\"MALWARE_SCAN_SCHEDULE\": {\"day_of_month\": $day_of_month, \"hour\": $hour}}"

    scan_date=$(imunify-antivirus config show | tr ',' '\n' | grep -w "day_of_month" | awk '{print $NF}')

    if [ $scan_date -ne $day_of_month ]; then
        content=$(echo "imunifyAV scan date: $scan_date - NOT UPDATED")

        send_sms

        send_mail
    fi
}

function send_sms() {
    message=$(echo "$hostname: $content")

    php $scripts/send_sms.php "$message" "$validation"
}

function send_mail() {
    echo "SUBJECT: imunifyAV Scanner - $(hostname) - $(date +"%F")" >>$svrlogs/mail/iavmail_$time.txt
    echo "FROM: ImunifyAV Scanner <root@$(hostname)>" >>$svrlogs/mail/iavmail_$time.txt
    echo "" >>$svrlogs/mail/iavmail_$time.txt
    printf "%-10s %20s\n" "Date:" "$(date +"%F")" >>$svrlogs/mail/iavmail_$time.txt
    printf "%-10s %20s\n" "Time:" "$(date +"%T")" >>$svrlogs/mail/iavmail_$time.txt
    printf "%-10s %20s\n" "Scan Date:" "$scan_date" >>$svrlogs/mail/iavmail_$time.txt
    printf "%-10s %20s\n" "Status:" "NOT UPDATED" >>$svrlogs/mail/iavmail_$time.txt
    sendmail "$emailmo,$emailmg" <$svrlogs/mail/iavmail_$time.txt
}

force_update

scan_date
