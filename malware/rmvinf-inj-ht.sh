#!/bin/bash

source /home/sample/scripts/dataset.sh

input=$1

function check_input() {
	username=$(cat /etc/trueuserowners | awk '{print $1}' | sed 's/://' | awk -v user=$input '{if ($1==user) print $1}')

	if [[ $input == "$username" ]]; then
		infected_list

		rmv_infected
	else
		echo "Username not found"
	fi
}

function infected_list() {
	grep -rnw /home/$username/public_html -e "<FilesMatch '.(py|exe|phtml|php|PHP|Php|PHp|pHp|pHP|pHP7|PHP7|phP|PhP|php5|suspected)$'>" >>$temp/$username-inf-inj_$time.txt
}

function rmv_infected() {
	if [ -r $temp/$username-inf-inj_$time.txt ] && [ -s $temp/$username-inf-inj_$time.txt ]; then

		while IFS= read -r line || [[ -n "$line" ]]; do
			file=$(echo "$line" | cut -d":" -f1)
			num=$(echo "$line" | cut -d":" -f2)

			start=$num

			if [[ ! -z $start && $start -ne 0 ]]; then
				end=$(printf %d "$(($num + 3))")

				last=$(sed -n '$=' "$file")

				sed -i "${start},${end}d" "$file"

				nlast=$(sed -n '$=' "$file")

				if [[ $nlast -lt $last ]]; then
					echo "Modified - $start - $end - $file" >>$svrlogs/malware/$username-inf-inj_$time.txt
				else
					echo "Not Modified - $start - $end - $file" >>$svrlogs/malware/$username-inf-inj_$time.txt
				fi

			else
				echo "Failed - $file" >>$svrlogs/malware/$username-inf-inj_$time.txt

			fi

		done <"$temp/$username-inf-inj_$time.txt"

	fi
}

check_input
