#!/bin/bash

source /home/sample/scripts/dataset.sh

input=$1
type=$2

function check_input() {
	username=$(cat /etc/trueuserowners | awk '{print $1}' | sed 's/://' | awk -v user=$input '{if ($1==user) print $1}')

	if [[ $input == "$username" ]]; then

		if [[ ! -z $type ]]; then

			infected_list

			rmv_infected
		else
			echo "Type not detected"
		fi
	else
		echo "Username not found"
	fi
}

function infected_list() {
	imunify-antivirus malware malicious list --user $username --limit 10000 | sed '1d' | awk '{$1=$2=$3=$4=$5=$6=$7=$(NF-9)=$(NF-8)=$(NF-7)=$(NF-6)=$(NF-5)=$(NF-4)=$(NF-3)=$(NF-2)=$NF=""; print}' | grep "$type" | sed 's/^[[:space:]]*//' >>$temp/$username-inf-type_$time.txt
}

function rmv_infected() {
	if [ -r $temp/$username-inf-type_$time.txt ] && [ -s $temp/$username-inf-type_$time.txt ]; then
		while IFS= read -r line || [[ -n "$line" ]]; do
			file=$(echo "$line" | awk '{$NF=""; print}' | sed 's/[[:blank:]]*$//')
			type=$(echo "$line" | awk '{print $NF}')

			rm -f "$file"

			echo "Removed - $file - $type" >>$svrlogs/malware/$username-inf-type_$time.txt

		done <"$temp/$username-inf-type_$time.txt"
	fi
}

check_input
